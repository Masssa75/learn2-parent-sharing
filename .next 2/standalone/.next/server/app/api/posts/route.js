(()=>{var e={};e.id=607,e.ids=[607],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},5511:e=>{"use strict";e.exports=require("crypto")},4735:e=>{"use strict";e.exports=require("events")},9021:e=>{"use strict";e.exports=require("fs")},1630:e=>{"use strict";e.exports=require("http")},5591:e=>{"use strict";e.exports=require("https")},1645:e=>{"use strict";e.exports=require("net")},1820:e=>{"use strict";e.exports=require("os")},3873:e=>{"use strict";e.exports=require("path")},1997:e=>{"use strict";e.exports=require("punycode")},7910:e=>{"use strict";e.exports=require("stream")},4631:e=>{"use strict";e.exports=require("tls")},9551:e=>{"use strict";e.exports=require("url")},4075:e=>{"use strict";e.exports=require("zlib")},6717:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>y,routeModule:()=>h,serverHooks:()=>w,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>x});var t={};s.r(t),s.d(t,{GET:()=>g,POST:()=>f});var o=s(2706),i=s(8203),n=s(5994),a=s(9187),u=s(4512),l=s(6464),c=s(4543);let p="https://yvzinotrjggncbwflxok.supabase.co",d=process.env.SUPABASE_SERVICE_ROLE_KEY,m=(0,l.UU)(p,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2emlub3RyamdnbmNid2ZseG9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjE3NTYsImV4cCI6MjA2NjU5Nzc1Nn0.AQlySfSa9wQAL5V_7DYQLEUzFYwNSUiuVJhfGvEbshA");async function g(e){try{let e=null;try{let r=(await (0,u.UL)()).get("session");if(r)try{e=JSON.parse(Buffer.from(r.value,"base64").toString()).userId,console.log("Session found, userId:",e)}catch(e){console.error("Failed to parse session:",e)}else console.log("No session cookie found")}catch(e){console.log("Error getting session:",e)}let{data:r,error:s}=await m.from("posts").select(`
        *,
        users!posts_user_id_fkey (
          id,
          telegram_username,
          first_name,
          last_name,
          photo_url
        ),
        categories (
          id,
          name,
          emoji
        )
      `).order("created_at",{ascending:!1}).limit(20);if(s)return console.error("Error fetching posts:",s),console.error("Error details:",JSON.stringify(s,null,2)),a.NextResponse.json({error:"Failed to fetch posts",details:s.message},{status:500});let t=new Set,o=new Set;if(e){let{data:r,error:s}=await m.from("likes").select("post_id").eq("user_id",e);s?console.error("Error fetching likes:",s):r&&(t=new Set(r.map(e=>e.post_id)),console.log(`User ${e} has ${r.length} likes`));let{data:i,error:n}=await m.from("saved_posts").select("post_id").eq("user_id",e);i&&(o=new Set(i.map(e=>e.post_id)))}let i=r?.map(e=>{let s=null;e.link_url&&(s=function(e){try{let r=new URL(e);if("www.youtube.com"===r.hostname||"youtube.com"===r.hostname){if("/watch"===r.pathname)return r.searchParams.get("v");if(r.pathname.startsWith("/embed/"))return r.pathname.split("/")[2]}if("youtu.be"===r.hostname)return r.pathname.slice(1);return null}catch{return null}}(e.link_url));let i=t.has(e.id);return r&&0===r.indexOf(e)&&console.log(`First post (${e.id}) liked status: ${i}, userLikes has ${t.size} items`),{id:e.id,userId:e.user_id,user:{name:e.users?`${e.users.first_name} ${e.users.last_name||""}`.trim():"Anonymous",username:e.users?.telegram_username||"anonymous",avatar:e.users?.photo_url||null},category:{name:e.categories?.name||"Unknown",emoji:e.categories?.emoji||"❓"},title:e.title,description:e.description,ageRange:e.age_ranges?.join(", ")||"",likes:e.likes_count||0,comments:e.comments_count||0,saved:o.has(e.id),liked:i,linkUrl:e.link_url,youtubeVideoId:s,imageUrl:e.image_url,createdAt:e.created_at}})||[];return a.NextResponse.json({posts:i})}catch(e){return console.error("Error in GET /api/posts:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{console.log("POST /api/posts - Starting...");let r=(await (0,u.UL)()).get("session");if(console.log("Session cookie:",r?"Present":"Missing"),!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=JSON.parse(Buffer.from(r.value,"base64").toString()).userId;console.log("User ID from session:",s);let{title:t,description:o,category:i,ageRanges:n,linkUrl:l,imageUrl:p}=await e.json();if(console.log("Post data received:",{title:t,category:i,ageRanges:n?.length}),!t||!o||!i||!n||0===n.length)return a.NextResponse.json({error:"Missing required fields"},{status:400});console.log("Looking up category:",i);let{data:d,error:g}=await m.from("categories").select("id").eq("name",i).single();if(g||!d)return console.error("Category lookup failed:",g),console.log("Available categories should be checked in the database"),a.NextResponse.json({error:"Invalid category",details:g?.message||"Category not found",categorySearched:i},{status:400});console.log("Category found:",d.id);let{data:f,error:h}=await m.from("posts").insert({user_id:s,title:(0,c.S)(t),description:o,category_id:d.id,age_ranges:n,link_url:l||null,image_url:p||null,likes_count:0,comments_count:0}).select().single();if(h)return console.error("Error creating post:",h),console.error("Post data attempted:",{user_id:s,title:t,description:o,category_id:d.id,age_ranges:n,link_url:l}),a.NextResponse.json({error:"Failed to create post",details:h.message,hint:h.hint||"Check if user exists in database"},{status:500});return a.NextResponse.json({success:!0,post:f},{status:201})}catch(e){return console.error("Error in POST /api/posts:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}(0,l.UU)(p,d);let h=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/posts/route",pathname:"/api/posts",filename:"route",bundlePath:"app/api/posts/route"},resolvedPagePath:"/Users/marcschwyn/Desktop/projects/Learn2/app/api/posts/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:_,workUnitAsyncStorage:x,serverHooks:w}=h;function y(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:x})}},6487:()=>{},8335:()=>{},4543:(e,r,s)=>{"use strict";function t(e){let r=["a","an","and","as","at","but","by","for","from","in","into","nor","of","on","or","so","the","to","up","with","yet"],s=["AI","API","CEO","CTO","FAQ","HR","ID","IT","URL","USA","UK","LEGO"];return e.split(" ").map((e,t)=>(e=e.trim())?s.find(r=>r.toLowerCase()===e.toLowerCase())||(t>0&&r.includes(e.toLowerCase())?e.toLowerCase():e.includes("-")?e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("-"):e.includes("'")?e.split("'").map((e,r)=>0===r?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e.toLowerCase()).join("'"):e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()):e).join(" ")}s.d(r,{S:()=>t})}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[989,452,512,464],()=>s(6717));module.exports=t})();